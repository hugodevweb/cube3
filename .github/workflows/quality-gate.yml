# ─────────────────────────────────────────────────────────────────────────────
# Quality Gate — runs every service's unit tests in parallel.
# Produces:
#   • Per-service coverage metrics table in the GitHub Actions job summary
#   • Downloadable HTML coverage report artifact per service
#   • A final gate job that blocks merges on any failure
#
# Recommended branch protection: require the status check
#   "Quality Gate — PASS / FAIL"
# to pass before merging into main.
# ─────────────────────────────────────────────────────────────────────────────
name: "Quality Gate"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ─── Job 1: run each service's tests + collect coverage ────────────────────
  test:
    name: "Tests — ${{ matrix.service }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false   # run ALL services even if one fails — show full picture
      matrix:
        include:
          - service: auth
            path: services/auth
          - service: gateway
            path: services/gateway
          - service: vente
            path: services/vente
          - service: communaute
            path: services/communaute
          - service: media
            path: services/media

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Setup Node.js 20"
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "Install dependencies"
        working-directory: ${{ matrix.path }}
        run: npm ci

      # Generate coverage in three formats:
      #   text    → printed to the workflow log
      #   json-summary → machine-readable totals for the step summary table
      #   html    → uploaded as a downloadable artifact
      - name: "Run unit tests with coverage"
        id: jest
        working-directory: ${{ matrix.path }}
        run: |
          npm test -- \
            --coverage \
            --coverageReporters=text \
            --coverageReporters=json-summary \
            --coverageReporters=html \
            --passWithNoTests \
            --forceExit

      # ── Coverage summary table ──────────────────────────────────────────────
      - name: "Publish coverage metrics to job summary"
        if: always()
        run: |
          SERVICE="${{ matrix.service }}"
          SUMMARY="${{ matrix.path }}/coverage/coverage-summary.json"

          if [ "${{ steps.jest.outcome }}" = "success" ]; then
            BADGE="✅"
          else
            BADGE="❌"
          fi

          echo "## ${BADGE} ${SERVICE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "$SUMMARY" ]; then
            STMT=$(node -e "const c=require('./$SUMMARY').total;console.log(c.statements.pct+'%')")
            BRNCH=$(node -e "const c=require('./$SUMMARY').total;console.log(c.branches.pct+'%')")
            FUNC=$(node -e "const c=require('./$SUMMARY').total;console.log(c.functions.pct+'%')")
            LINES=$(node -e "const c=require('./$SUMMARY').total;console.log(c.lines.pct+'%')")

            echo "| Metric | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|:--------:|" >> $GITHUB_STEP_SUMMARY
            echo "| Statements | \`${STMT}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Branches   | \`${BRNCH}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Functions  | \`${FUNC}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Lines      | \`${LINES}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "_No coverage data generated._" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

      # ── HTML report artifact ────────────────────────────────────────────────
      - name: "Upload HTML coverage report"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "coverage-${{ matrix.service }}"
          path: "${{ matrix.path }}/coverage/lcov-report"
          retention-days: 7
          if-no-files-found: ignore

  # ─── Job 2: aggregate gate — this is the required status check ─────────────
  gate:
    name: "Quality Gate — PASS / FAIL"
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: "Evaluate gate"
        run: |
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "## ✅ Quality Gate PASSED — all tests green" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Every service is healthy. HTML coverage reports are available as artifacts." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "## ❌ Quality Gate FAILED — push blocked" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more services failed their tests. Fix the red jobs before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
